name: CI-CD-Pipeline-Prime-API

# Triggers: El pipeline se activa al subir c贸digo o abrir PRs en ramas clave
on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

jobs:
  # TRABAJO 1: Calidad y Pruebas (CI)
  quality-and-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del c贸digo
        uses: actions/checkout@v4

      - name: Configurar Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8

      # Q4: An谩lisis Est谩tico - Cr铆tica t茅cnica inmediata (Shift-left)
      - name: Static Analysis - Linter (Q4)
        run: flake8 src/backend --count --statistics

      # Q1: Tests Unitarios - Verificaci贸n de la l贸gica matem谩tica
      - name: Run Unit Tests (Q1)
        env:
          PYTHONPATH: .
        run: pytest src/backend/tests

      # Q2: Tests de Aceptaci贸n (BDD) - Verificaci贸n de reglas de negocio
      - name: Run Acceptance Tests (Q2)
        env:
          PYTHONPATH: .
        run: behave src/backend/tests/features/

  # TRABAJO 2: Despliegue Continuo (CD)
  deploy:
    # Este trabajo solo se ejecuta si el anterior (tests) termina en verde
    needs: quality-and-tests
    # Solo se despliega si el c贸digo llega a la rama 'main'
    if: github.ref_name == 'main'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout del c贸digo
        uses: actions/checkout@v4

      # Simulaci贸n de creaci贸n de artefacto inmutable (Docker)
      - name: Build Docker Image
        run: |
          docker build -t prime-calculator-api:latest .
          echo "[CD] Imagen de Docker construida correctamente."

      # Simulaci贸n de despliegue en entorno de producci贸n
      - name: Simulate Cloud Deployment
        run: |
          echo "[CD] Desplegando en el servidor de producci贸n..."
          echo "[CD] Verificando Healthcheck del servicio..."
          echo "[CD] 隆La API de Prime Calculator est谩 online y desplegada! "